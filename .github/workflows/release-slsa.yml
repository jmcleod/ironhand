name: Release (SLSA provenance)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions: read-all

jobs:
  build:
    name: Build release artifacts
    runs-on: ubuntu-latest
    outputs:
      hashes: ${{ steps.hashes.outputs.hashes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # Keep in sync with go.mod once you bump it
          go-version-file: go.mod
          cache: true

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install Task
        run: |
          go install github.com/go-task/task/v3/cmd/task@latest
          echo "$HOME/go/bin" >> "$GITHUB_PATH"

      # Runs vet/test/web:build/web:test/build as per your Taskfile.yml `ci` task
      - name: Run CI task pipeline
        run: task ci

      # Create a deterministic-ish release binary (and ensure web build output is present for embed)
      - name: Build release binary (linux-amd64)
        env:
          CGO_ENABLED: "0"
          GOOS: linux
          GOARCH: amd64
        run: |
          mkdir -p dist
          go build -trimpath -o dist/ironhand-linux-amd64 ./cmd/ironhand

      - name: Generate SHA256 subjects (for provenance)
        id: hashes
        shell: bash
        run: |
          # Must match sha256sum output format: "<hash><space><filename>\n"
          echo "hashes=$(sha256sum dist/* | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Upload release artifacts (workflow run)
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: dist/*
          if-no-files-found: error
          retention-days: 7

  provenance:
    name: Generate SLSA provenance
    needs: [build]
    permissions:
      contents: read
      actions: read     # required by generator
      id-token: write   # required to sign provenance
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: false

  release:
    name: Publish GitHub Release
    needs: [build, provenance]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist

      - name: Download provenance
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.provenance.outputs.provenance-name }}
          path: dist

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
