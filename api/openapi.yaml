openapi: 3.0.3
info:
  title: Ironhand API
  description: A secure vault service with end-to-end encryption.
  version: 1.0.0
servers:
  - url: /api/v1
    description: V1 API

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: ironhand_session
      description: >
        HTTP-only session cookie returned by /auth/register or /auth/login.
        A companion `ironhand_session_key` cookie (SameSite=Strict) is also set
        and required for credential derivation. The session passphrase is derived
        at request time via HMAC-SHA256 from the session ID and the session secret
        cookie, ensuring that neither the server-side session store nor the client
        cookie alone can reconstruct vault credentials.

  parameters:
    CSRFToken:
      name: X-CSRF-Token
      in: header
      required: true
      description: >
        CSRF double-submit token. Must match the value of the `ironhand_csrf`
        cookie. Required on all mutating (POST/PUT/DELETE) requests that use
        cookie-based session authentication. GET/HEAD/OPTIONS requests and
        header-authenticated requests are exempt.
      schema:
        type: string

    PaginationLimit:
      name: limit
      in: query
      required: false
      description: Maximum number of items to return (default 100, max 200).
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 100

    PaginationOffset:
      name: offset
      in: query
      required: false
      description: Number of items to skip for pagination.
      schema:
        type: integer
        minimum: 0
        default: 0

  schemas:
    PaginationMeta:
      type: object
      properties:
        total_count:
          type: integer
          description: Total number of items matching the query.
        limit:
          type: integer
          description: Maximum items per page (server-capped at 200).
        offset:
          type: integer
          description: Number of items skipped.
        has_more:
          type: boolean
          description: Whether more items exist beyond this page.

    CreateVaultRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    CreateVaultResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string
        epoch:
          type: integer
          format: int64

    RegisterRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          minLength: 10
          description: Master passphrase (minimum 10 characters).

    RegisterResponse:
      type: object
      properties:
        secret_key:
          type: string

    LoginRequest:
      type: object
      required:
        - passphrase
        - secret_key
      properties:
        passphrase:
          type: string
        secret_key:
          type: string
        totp_code:
          type: string
          description: 6-digit TOTP code, required when 2FA is enabled.
        recovery_code:
          type: string
          description: One-time recovery code, accepted in place of totp_code when 2FA is enabled.

    SetupTwoFactorResponse:
      type: object
      properties:
        secret:
          type: string
        otpauth_url:
          type: string
        expires_at:
          type: string
          format: date-time

    EnableTwoFactorRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string

    TwoFactorStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean

    WebAuthnStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean
        credential_count:
          type: integer

    WebAuthnLoginRequest:
      type: object
      required:
        - secret_key
        - passphrase
      properties:
        secret_key:
          type: string
        passphrase:
          type: string
          description: Passphrase for vault decryption after WebAuthn verification.

    WebAuthnRegistrationResponse:
      type: object
      properties:
        credential_id:
          type: string

    ExportAuditEntryResponse:
      type: object
      properties:
        id:
          type: string
        vault_id:
          type: string
        item_id:
          type: string
        action:
          type: string
        member_id:
          type: string
        created_at:
          type: string
          format: date-time
        prev_hash:
          type: string
          description: SHA-256 hash linking this entry to its predecessor in the tamper-evident chain.

    ExportAuditLogResponse:
      type: object
      properties:
        vault_id:
          type: string
        entries:
          type: array
          items:
            $ref: '#/components/schemas/ExportAuditEntryResponse'
        signature:
          type: string
          description: HMAC-SHA256 signature over all entries for forensic integrity verification.

    OpenVaultResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string
        epoch:
          type: integer
          format: int64

    VaultSummary:
      type: object
      properties:
        vault_id:
          type: string
        name:
          type: string
        description:
          type: string
        epoch:
          type: integer
          format: int64
        item_count:
          type: integer

    ListVaultsResponse:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            vaults:
              type: array
              items:
                $ref: '#/components/schemas/VaultSummary'

    ListItemsResponse:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/ItemSummary'

    ItemSummary:
      type: object
      properties:
        item_id:
          type: string
        name:
          type: string
        type:
          type: string
        version:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        preview:
          type: object
          additionalProperties:
            type: string
          description: Subset of non-sensitive fields for display without opening the item.

    PutItemRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            Attachment fields use special prefixes:
            "_att.<filename>" for base64-encoded binary content (max 768 KiB decoded),
            "_attmeta.<filename>" for JSON metadata (content_type, size).
            Each attachment uses 2 fields toward the 64-field limit.

    GetItemResponse:
      type: object
      properties:
        item_id:
          type: string
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            Attachment content fields ("_att.*") are base64-encoded.
            Sensitive fields such as `private_key` are returned as "[REDACTED]".
            Use the dedicated /private-key endpoint to retrieve the full value.

    UpdateItemRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            See PutItemRequest for attachment field conventions.

    AddMemberRequest:
      type: object
      required:
        - member_id
        - pub_key
        - role
      properties:
        member_id:
          type: string
        pub_key:
          type: string
          description: Base64 encoded 32-byte public key.
        role:
          type: string
          enum: [owner, writer, reader]

    AddMemberResponse:
      type: object
      properties:
        epoch:
          type: integer
          format: int64

    HistoryEntryResponse:
      type: object
      properties:
        version:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: string

    GetItemHistoryResponse:
      type: object
      properties:
        item_id:
          type: string
        history:
          type: array
          items:
            $ref: '#/components/schemas/HistoryEntryResponse'

    GetHistoryVersionResponse:
      type: object
      properties:
        item_id:
          type: string
        version:
          type: integer
          format: int64
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value at this version. Text fields are plain strings.
            Attachment content fields ("_att.*") are base64-encoded.

    AuditEntryResponse:
      type: object
      properties:
        id:
          type: string
        item_id:
          type: string
        action:
          type: string
          enum: [item_accessed, item_created, item_updated, item_deleted, vault_exported, vault_imported, ca_initialized, cert_issued, cert_revoked, cert_renewed, crl_generated, csr_signed, private_key_accessed, webauthn_registered, webauthn_login_success]
        member_id:
          type: string
        created_at:
          type: string
          format: date-time

    ListAuditLogsResponse:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            entries:
              type: array
              items:
                $ref: '#/components/schemas/AuditEntryResponse'

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        correlation_id:
          type: string
          description: Request correlation ID for support and debugging.

    ExportVaultRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          description: Passphrase to encrypt the backup file. Must not be empty.

    ImportVaultResponse:
      type: object
      properties:
        imported_count:
          type: integer
          description: Number of items successfully imported.

    InitCARequest:
      type: object
      required:
        - common_name
      properties:
        common_name:
          type: string
        organization:
          type: string
        org_unit:
          type: string
        country:
          type: string
        province:
          type: string
        locality:
          type: string
        validity_years:
          type: integer
          description: CA certificate validity in years (default 10).
        is_intermediate:
          type: boolean
          description: Whether this is an intermediate CA (default false = root CA).

    InitCAResponse:
      type: object
      properties:
        subject:
          type: string

    CAInfoResponse:
      type: object
      properties:
        is_ca:
          type: boolean
        is_intermediate:
          type: boolean
        subject:
          type: string
        not_before:
          type: string
          format: date-time
        not_after:
          type: string
          format: date-time
        next_serial:
          type: integer
          format: int64
        crl_number:
          type: integer
          format: int64
        cert_count:
          type: integer

    IssueCertRequest:
      type: object
      required:
        - common_name
      properties:
        common_name:
          type: string
        organization:
          type: string
        org_unit:
          type: string
        country:
          type: string
        validity_days:
          type: integer
          description: Certificate validity in days (default 365).
        key_usages:
          type: array
          items:
            type: string
          description: >
            Key usage flags. Values: digital_signature, key_encipherment,
            data_encipherment, content_commitment.
        ext_key_usages:
          type: array
          items:
            type: string
          description: >
            Extended key usage values. Values: server_auth, client_auth,
            code_signing, email_protection.
        dns_names:
          type: array
          items:
            type: string
        ip_addresses:
          type: array
          items:
            type: string
        email_addresses:
          type: array
          items:
            type: string

    IssueCertResponse:
      type: object
      properties:
        item_id:
          type: string
        serial_number:
          type: string
        subject:
          type: string
        not_before:
          type: string
          format: date-time
        not_after:
          type: string
          format: date-time

    RevokeCertRequest:
      type: object
      properties:
        reason:
          type: string
          description: >
            Revocation reason. Values: unspecified, key_compromise,
            ca_compromise, affiliation_changed, superseded, cessation_of_operation.

    RenewCertRequest:
      type: object
      properties:
        validity_days:
          type: integer
          description: New certificate validity in days (default 365).

    RenewCertResponse:
      type: object
      properties:
        new_item_id:
          type: string
        old_item_id:
          type: string
        serial_number:
          type: string

    SignCSRRequest:
      type: object
      required:
        - csr
      properties:
        csr:
          type: string
          description: PEM-encoded PKCS#10 certificate signing request.
        validity_days:
          type: integer
          description: Certificate validity in days (default 365).
        ext_key_usages:
          type: array
          items:
            type: string

    SignCSRResponse:
      type: object
      properties:
        item_id:
          type: string
        serial_number:
          type: string
        certificate:
          type: string
          description: PEM-encoded signed certificate.

    # ─── 2FA / Auth Settings ──────────────────────────────────────────

    DisableTwoFactorRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
          description: Valid TOTP code to confirm 2FA disable.

    AuthSettingsResponse:
      type: object
      properties:
        passkey_policy:
          type: string
          enum: [allowed, required, disabled]
          description: WebAuthn/passkey login policy.
        totp_enabled:
          type: boolean

    UpdateAuthSettingsRequest:
      type: object
      required:
        - passkey_policy
      properties:
        passkey_policy:
          type: string
          enum: [allowed, required, disabled]

    # ─── Step-Up Authentication ───────────────────────────────────────

    StepUpTOTPRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string
          description: 6-digit TOTP code for step-up verification.

    StepUpResponse:
      type: object
      properties:
        verified:
          type: boolean
        method:
          type: string
          description: Method used for step-up (totp or passkey).
        expires_at:
          type: string
          format: date-time

    StepUpRequiredResponse:
      type: object
      properties:
        error:
          type: string
        methods:
          type: array
          items:
            type: string
          description: Available step-up methods (e.g. ["totp", "passkey"]).

    # ─── Item Mutations & Versions ────────────────────────────────────

    MutationResponse:
      type: object
      properties:
        item_id:
          type: string
        version:
          type: integer
          format: int64

    ItemVersionsResponse:
      type: object
      properties:
        versions:
          type: object
          additionalProperties:
            type: integer
          description: Map of item_id to current version number.
        epoch:
          type: integer
          format: int64

    # ─── Members ──────────────────────────────────────────────────────

    MemberSummary:
      type: object
      properties:
        member_id:
          type: string
        role:
          type: string
          enum: [owner, writer, reader]
        status:
          type: string
        added_epoch:
          type: integer
          format: int64

    ListMembersResponse:
      type: object
      properties:
        members:
          type: array
          items:
            $ref: '#/components/schemas/MemberSummary'

    ChangeMemberRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          type: string
          enum: [owner, writer, reader]

    # ─── Invites ──────────────────────────────────────────────────────

    CreateInviteRequest:
      type: object
      required:
        - role
      properties:
        role:
          type: string
          enum: [owner, writer, reader]

    CreateInviteResponse:
      type: object
      properties:
        token:
          type: string
        passphrase:
          type: string
          description: >
            One-time passphrase for the invitee. Must be shared out-of-band.
            The server does NOT store this — it is used as the Argon2id encryption
            key for the credential blob.
        expires_at:
          type: string
          format: date-time
        invite_url:
          type: string
          description: Full URL the invitee can visit to accept.

    InviteSummary:
      type: object
      properties:
        token:
          type: string
        role:
          type: string
          enum: [owner, writer, reader]
        expires_at:
          type: string
          format: date-time

    ListInvitesResponse:
      type: object
      properties:
        invites:
          type: array
          items:
            $ref: '#/components/schemas/InviteSummary'

    InviteInfoResponse:
      type: object
      properties:
        vault_name:
          type: string
        role:
          type: string
          enum: [owner, writer, reader]
        expires_at:
          type: string
          format: date-time
        creator_id:
          type: string

    AcceptInviteRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          description: Invite passphrase shared by the creator.

    AcceptInviteResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string

    # ─── Passkey Management ───────────────────────────────────────────

    PasskeySummary:
      type: object
      properties:
        credential_id:
          type: string
        label:
          type: string
        created_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time
        backup_state:
          type: boolean

    ListPasskeysResponse:
      type: object
      properties:
        passkeys:
          type: array
          items:
            $ref: '#/components/schemas/PasskeySummary'

    LabelPasskeyRequest:
      type: object
      required:
        - label
      properties:
        label:
          type: string

    # ─── Recovery Codes ───────────────────────────────────────────────

    RecoveryCodesStatusResponse:
      type: object
      properties:
        has_codes:
          type: boolean
        codes_total:
          type: integer
        codes_unused:
          type: integer

    GenerateRecoveryCodesResponse:
      type: object
      properties:
        codes:
          type: array
          items:
            type: string
          description: One-time recovery codes. Store securely — they cannot be viewed again.

    # ─── Cross-Vault Search ───────────────────────────────────────────

    SearchResultItem:
      type: object
      properties:
        vault_id:
          type: string
        vault_name:
          type: string
        item_id:
          type: string
        name:
          type: string
        type:
          type: string
        matched_field:
          type: string

    SearchResponse:
      allOf:
        - $ref: '#/components/schemas/PaginationMeta'
        - type: object
          properties:
            results:
              type: array
              items:
                $ref: '#/components/schemas/SearchResultItem'

paths:
  /auth/register:
    post:
      summary: Register a new account
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: >
            Account created. Sets `ironhand_session` (SameSite=Lax) and
            `ironhand_session_key` (SameSite=Strict) cookies.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Invalid request (e.g. passphrase too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login with passphrase and secret key
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: >
            Logged in. Sets `ironhand_session` (SameSite=Lax) and
            `ironhand_session_key` (SameSite=Strict) cookies.
        '401':
          description: Invalid credentials
        '429':
          description: Too many failed login attempts
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      summary: Logout current session
      operationId: logout
      responses:
        '200':
          description: Logged out

  /auth/2fa:
    get:
      summary: Get 2FA status for current account
      operationId: twoFactorStatus
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 2FA status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '401':
          description: Unauthorized

  /auth/2fa/setup:
    post:
      summary: Start 2FA setup and return a TOTP secret
      operationId: setupTwoFactor
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 2FA setup initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetupTwoFactorResponse'
        '401':
          description: Unauthorized

  /auth/2fa/enable:
    post:
      summary: Enable 2FA by verifying a TOTP code
      operationId: enableTwoFactor
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnableTwoFactorRequest'
      responses:
        '200':
          description: 2FA enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '400':
          description: Setup expired or invalid request
        '401':
          description: Invalid one-time code or unauthorized

  /auth/2fa/disable:
    post:
      summary: Disable 2FA
      operationId: disableTwoFactor
      description: >
        Disables TOTP two-factor authentication. Requires a valid TOTP code
        to confirm the action.
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DisableTwoFactorRequest'
      responses:
        '200':
          description: 2FA disabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '400':
          description: Invalid or missing TOTP code
        '401':
          description: Unauthorized

  /auth/webauthn/status:
    get:
      summary: Get WebAuthn/passkey status
      operationId: webauthnStatus
      security:
        - SessionAuth: []
      responses:
        '200':
          description: WebAuthn status and credential count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnStatusResponse'
        '401':
          description: Unauthorized

  /auth/webauthn/register/begin:
    post:
      summary: Begin WebAuthn credential registration
      operationId: beginWebAuthnRegistration
      description: >
        Starts a WebAuthn registration ceremony. Returns PublicKeyCredentialCreationOptions
        for the browser to pass to navigator.credentials.create().
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Credential creation options
        '401':
          description: Unauthorized
        '404':
          description: WebAuthn not configured on server

  /auth/webauthn/register/finish:
    post:
      summary: Complete WebAuthn credential registration
      operationId: finishWebAuthnRegistration
      description: >
        Completes the WebAuthn registration ceremony by verifying the browser's
        attestation response and storing the credential.
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Credential registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnRegistrationResponse'
        '400':
          description: Registration failed or ceremony expired
        '401':
          description: Unauthorized
        '404':
          description: WebAuthn not configured on server

  /auth/webauthn/login/begin:
    post:
      summary: Begin WebAuthn login ceremony
      operationId: beginWebAuthnLogin
      description: >
        Starts a WebAuthn login ceremony. Requires secret_key and passphrase in the
        body because the passphrase is needed for vault decryption after successful
        WebAuthn verification. Returns PublicKeyCredentialRequestOptions for the
        browser to pass to navigator.credentials.get().
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnLoginRequest'
      responses:
        '200':
          description: Credential request options
        '400':
          description: No WebAuthn credentials registered
        '404':
          description: WebAuthn not configured on server
        '429':
          description: Too many failed login attempts
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer

  /auth/webauthn/login/finish:
    post:
      summary: Complete WebAuthn login ceremony
      operationId: finishWebAuthnLogin
      description: >
        Completes the WebAuthn login ceremony by verifying the browser's assertion
        response. On success, creates a full session (sets session and CSRF cookies).
      responses:
        '200':
          description: >
            Login successful. Sets `ironhand_session` (SameSite=Lax) and
            `ironhand_session_key` (SameSite=Strict) cookies.
        '400':
          description: Ceremony expired or invalid response
        '401':
          description: WebAuthn verification failed or invalid passphrase
        '404':
          description: WebAuthn not configured on server

  /auth/webauthn/credentials:
    get:
      summary: List registered passkeys
      operationId: listPasskeys
      security:
        - SessionAuth: []
      responses:
        '200':
          description: Passkey list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListPasskeysResponse'
        '401':
          description: Unauthorized

  /auth/webauthn/credentials/{credentialID}:
    put:
      summary: Label a passkey
      operationId: labelPasskey
      security:
        - SessionAuth: []
      parameters:
        - name: credentialID
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LabelPasskeyRequest'
      responses:
        '204':
          description: Label updated
        '401':
          description: Unauthorized
        '404':
          description: Credential not found
    delete:
      summary: Delete a passkey
      operationId: deletePasskey
      security:
        - SessionAuth: []
      parameters:
        - name: credentialID
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '204':
          description: Passkey deleted
        '401':
          description: Unauthorized
        '404':
          description: Credential not found

  /auth/recovery-codes:
    get:
      summary: Get recovery codes status
      operationId: recoveryCodesStatus
      security:
        - SessionAuth: []
      responses:
        '200':
          description: Recovery codes status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecoveryCodesStatusResponse'
        '401':
          description: Unauthorized
    post:
      summary: Generate new recovery codes
      operationId: generateRecoveryCodes
      description: >
        Generates a new set of one-time recovery codes. Any existing unused
        codes are replaced.
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: New recovery codes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateRecoveryCodesResponse'
        '401':
          description: Unauthorized

  /auth/settings:
    get:
      summary: Get authentication settings
      operationId: getAuthSettings
      security:
        - SessionAuth: []
      responses:
        '200':
          description: Current auth settings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSettingsResponse'
        '401':
          description: Unauthorized
    put:
      summary: Update authentication settings
      operationId: updateAuthSettings
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAuthSettingsRequest'
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSettingsResponse'
        '400':
          description: Invalid policy value
        '401':
          description: Unauthorized

  /auth/step-up:
    post:
      summary: Step-up authentication via TOTP
      operationId: stepUpTOTP
      description: >
        Elevates the current session for sensitive operations by verifying
        a TOTP code. The step-up is valid for a limited time window.
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StepUpTOTPRequest'
      responses:
        '200':
          description: Step-up verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StepUpResponse'
        '401':
          description: Invalid TOTP code or unauthorized

  /auth/step-up/passkey/begin:
    post:
      summary: Begin step-up authentication via passkey
      operationId: beginStepUpPasskey
      description: >
        Starts a WebAuthn assertion ceremony for step-up authentication.
        Returns PublicKeyCredentialRequestOptions.
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Credential request options
        '401':
          description: Unauthorized
        '404':
          description: No passkeys registered

  /auth/step-up/passkey/finish:
    post:
      summary: Complete step-up authentication via passkey
      operationId: finishStepUpPasskey
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Step-up verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StepUpResponse'
        '400':
          description: Ceremony expired or invalid response
        '401':
          description: Unauthorized

  /invites/{token}:
    get:
      summary: Get invite information
      operationId: getInviteInfo
      description: >
        Returns metadata about a pending invite (vault name, role, expiry).
        Used by the invitee before accepting.
      security:
        - SessionAuth: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Invite details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InviteInfoResponse'
        '401':
          description: Unauthorized
        '404':
          description: Invite not found or expired

  /invites/{token}/accept:
    post:
      summary: Accept a vault invite
      operationId: acceptInvite
      description: >
        Accepts a pending invite using the passphrase shared by the creator.
        The passphrase decrypts the credential blob (Argon2id + AES-256-GCM).
        Wrong passphrase = decryption failure = 403.
      security:
        - SessionAuth: []
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcceptInviteRequest'
      responses:
        '200':
          description: Invite accepted, vault membership granted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AcceptInviteResponse'
        '400':
          description: Missing passphrase
        '401':
          description: Unauthorized
        '403':
          description: Wrong passphrase (decryption failed)
        '404':
          description: Invite not found or expired

  /search:
    get:
      summary: Search items across all accessible vaults
      operationId: searchItems
      security:
        - SessionAuth: []
      parameters:
        - name: q
          in: query
          required: true
          description: Search query string.
          schema:
            type: string
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationOffset'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          description: Missing or empty query
        '401':
          description: Unauthorized

  /vaults:
    get:
      summary: List vaults visible to authenticated member
      operationId: listVaults
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationOffset'
      responses:
        '200':
          description: Vault list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListVaultsResponse'
        '401':
          description: Unauthorized
    post:
      summary: Create a new vault
      operationId: createVault
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVaultRequest'
      responses:
        '201':
          description: Vault created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateVaultResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/open:
    post:
      summary: Open a vault
      operationId: openVault
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vault opened successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenVaultResponse'
        '401':
          description: Unauthorized
        '404':
          description: Vault not found

  /vaults/{vaultID}/items:
    get:
      summary: List items in a vault
      operationId: listItems
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationOffset'
      responses:
        '200':
          description: List of item IDs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/versions:
    get:
      summary: Get current version numbers for all items in a vault
      operationId: listItemVersions
      description: >
        Returns a map of item_id to current version number, along with the
        vault epoch. Useful for detecting changes since the last sync.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item version manifest
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemVersionsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}:
    get:
      summary: Get an item from a vault
      operationId: getItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetItemResponse'
        '401':
          description: Unauthorized
        '404':
          description: Item not found
    post:
      summary: Put an item into a vault
      operationId: putItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PutItemRequest'
      responses:
        '201':
          description: Item stored successfully
        '401':
          description: Unauthorized
    put:
      summary: Update an item in a vault
      operationId: updateItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
      responses:
        '200':
          description: Item updated successfully
        '401':
          description: Unauthorized
        '404':
          description: Item not found
    delete:
      summary: Delete an item from a vault
      operationId: deleteItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item deleted successfully
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}/history:
    get:
      summary: List version history for an item
      operationId: getItemHistory
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetItemHistoryResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}/history/{version}:
    get:
      summary: Get fields for a specific historical version of an item
      operationId: getHistoryVersion
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
        - name: version
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Historical version fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetHistoryVersionResponse'
        '401':
          description: Unauthorized
        '404':
          description: Version not found

  /vaults/{vaultID}/items/{itemID}/private-key:
    get:
      summary: Get the private key for a certificate item
      operationId: getItemPrivateKey
      description: >
        Returns the full PEM-encoded private key for a certificate item.
        Requires owner access. The standard GetItem endpoint redacts the
        private_key field to "[REDACTED]" for security. This dedicated
        endpoint provides the real value and logs an audit event.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Private key PEM
          content:
            application/x-pem-file:
              schema:
                type: string
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner)
        '404':
          description: Item not found or has no private key

  /vaults/{vaultID}/audit:
    get:
      summary: List vault audit log entries
      operationId: listAuditLogs
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: item_id
          in: query
          required: false
          schema:
            type: string
        - $ref: '#/components/parameters/PaginationLimit'
        - $ref: '#/components/parameters/PaginationOffset'
      responses:
        '200':
          description: Audit log entries (newest first)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAuditLogsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/audit/export:
    get:
      summary: Export tamper-evident audit log
      operationId: exportAuditLog
      description: >
        Returns all audit entries for the vault with their chain hashes and
        an HMAC-SHA256 signature for forensic integrity verification. Entries
        are ordered chronologically (oldest first) and linked via prev_hash
        to form a tamper-evident chain.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Audit log with chain integrity data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportAuditLogResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/members:
    get:
      summary: List vault members
      operationId: listMembers
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMembersResponse'
        '401':
          description: Unauthorized
    post:
      summary: Add a member to a vault
      operationId: addMember
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberRequest'
      responses:
        '201':
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/members/{memberID}:
    put:
      summary: Change a member's role
      operationId: changeMemberRole
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: memberID
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangeMemberRoleRequest'
      responses:
        '204':
          description: Role updated
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (only owner can change roles)
        '404':
          description: Member not found
    delete:
      summary: Revoke a member from a vault
      operationId: revokeMember
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: memberID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}:
    delete:
      summary: Delete a vault
      operationId: deleteVault
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vault deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /vaults/{vaultID}/export:
    post:
      summary: Export all vault items as an encrypted backup
      operationId: exportVault
      description: >
        Requires owner access. Decrypts all current items, serializes to JSON,
        and encrypts with the provided passphrase using Argon2id + AES-256-GCM.
        History is not exported. The response is a binary blob.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportVaultRequest'
      responses:
        '200':
          description: Encrypted backup file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid request (e.g. empty passphrase)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner)

  /vaults/{vaultID}/invites:
    post:
      summary: Create a vault invite
      operationId: createInvite
      description: >
        Creates a pending invite for the vault. Returns a token and a one-time
        passphrase that must be shared with the invitee out-of-band. The passphrase
        is the Argon2id encryption key for the credential blob — it is NOT stored
        server-side.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInviteRequest'
      responses:
        '201':
          description: Invite created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateInviteResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (insufficient role)
    get:
      summary: List active invites for a vault
      operationId: listInvites
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Active invites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListInvitesResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/invites/{token}:
    delete:
      summary: Cancel a vault invite
      operationId: cancelInvite
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: token
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '204':
          description: Invite cancelled
        '401':
          description: Unauthorized
        '403':
          description: Only the invite creator can cancel
        '404':
          description: Invite not found

  /vaults/{vaultID}/pki/init:
    post:
      summary: Initialize vault as a Certificate Authority
      operationId: initCA
      description: >
        Creates a self-signed root CA (or intermediate CA) with the given subject.
        Generates an ECDSA P-256 CA key pair stored encrypted in the vault.
        Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitCARequest'
      responses:
        '200':
          description: CA initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitCAResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '409':
          description: Vault is already a CA
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/pki/info:
    get:
      summary: Get CA information
      operationId: getCAInfo
      description: Returns CA metadata including subject, validity, serial counter, and certificate count.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CA information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CAInfoResponse'
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/ca.pem:
    get:
      summary: Download CA certificate
      operationId: getCACert
      description: Returns the CA's X.509 certificate in PEM format.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CA certificate PEM
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/issue:
    post:
      summary: Issue a new certificate
      operationId: issueCert
      description: >
        Issues a new X.509 certificate signed by the vault's CA.
        Generates a new ECDSA P-256 key pair. The certificate and private key
        are stored as a vault item. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueCertRequest'
      responses:
        '200':
          description: Certificate issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssueCertResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/pki/items/{itemID}/revoke:
    post:
      summary: Revoke a certificate
      operationId: revokeCert
      description: >
        Marks a certificate as revoked. The revocation is recorded for CRL
        generation. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevokeCertRequest'
      responses:
        '200':
          description: Certificate revoked
        '401':
          description: Unauthorized
        '404':
          description: Certificate not found
        '409':
          description: Certificate already revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/pki/items/{itemID}/renew:
    post:
      summary: Renew a certificate
      operationId: renewCert
      description: >
        Revokes the existing certificate and issues a new one with the same
        subject and SANs. The new item links back to the old one via
        previous_item_id. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenewCertRequest'
      responses:
        '200':
          description: Certificate renewed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenewCertResponse'
        '401':
          description: Unauthorized
        '404':
          description: Certificate not found

  /vaults/{vaultID}/pki/crl.pem:
    get:
      summary: Generate and download Certificate Revocation List
      operationId: getCRL
      description: >
        Generates a CRL on demand from the vault's revocation list, signed
        by the CA. Returns the CRL in PEM format.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CRL in PEM format
          content:
            application/x-pem-file:
              schema:
                type: string
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/crl:
    post:
      summary: Regenerate and cache Certificate Revocation List
      operationId: generateCRL
      description: >
        Regenerates the CRL from the vault's revocation list and caches it.
        Unlike the GET /crl.pem endpoint which returns the cached CRL,
        this endpoint forces regeneration. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: CRL regenerated (PEM format)
          content:
            application/x-pem-file:
              schema:
                type: string
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/sign-csr:
    post:
      summary: Sign a Certificate Signing Request
      operationId: signCSR
      description: >
        Signs a PEM-encoded PKCS#10 CSR with the vault's CA. The resulting
        certificate is stored as a vault item (without private key, since the
        requester keeps their own key). Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignCSRRequest'
      responses:
        '200':
          description: CSR signed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignCSRResponse'
        '400':
          description: Invalid CSR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/import:
    post:
      summary: Import items from an encrypted backup into a vault
      operationId: importVault
      description: >
        Accepts a multipart form with the encrypted backup file and passphrase.
        Each imported item receives a new ID. Duplicates are not detected.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - passphrase
              properties:
                file:
                  type: string
                  format: binary
                  description: The .ironhand-backup file.
                passphrase:
                  type: string
                  description: Passphrase used to encrypt the backup.
      responses:
        '200':
          description: Items imported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportVaultResponse'
        '400':
          description: Invalid request, wrong passphrase, or corrupt file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
