openapi: 3.0.3
info:
  title: Ironhand API
  description: A secure vault service with end-to-end encryption.
  version: 1.0.0
servers:
  - url: /api/v1
    description: V1 API

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: ironhand_session
      description: HTTP-only session cookie returned by /auth/register or /auth/login.

  schemas:
    CreateVaultRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    CreateVaultResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string
        epoch:
          type: integer
          format: int64

    RegisterRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          minLength: 10
          description: Master passphrase (minimum 10 characters).

    RegisterResponse:
      type: object
      properties:
        secret_key:
          type: string

    LoginRequest:
      type: object
      required:
        - passphrase
        - secret_key
      properties:
        passphrase:
          type: string
        secret_key:
          type: string
        totp_code:
          type: string
          description: 6-digit TOTP code, required when 2FA is enabled.

    SetupTwoFactorResponse:
      type: object
      properties:
        secret:
          type: string
        otpauth_url:
          type: string
        expires_at:
          type: string
          format: date-time

    EnableTwoFactorRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string

    TwoFactorStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean

    OpenVaultResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string
        epoch:
          type: integer
          format: int64

    VaultSummary:
      type: object
      properties:
        vault_id:
          type: string
        name:
          type: string
        description:
          type: string
        epoch:
          type: integer
          format: int64
        item_count:
          type: integer

    ListVaultsResponse:
      type: object
      properties:
        vaults:
          type: array
          items:
            $ref: '#/components/schemas/VaultSummary'

    ListItemsResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemSummary'

    ItemSummary:
      type: object
      properties:
        item_id:
          type: string
        name:
          type: string
        type:
          type: string

    PutItemRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            Attachment fields use special prefixes:
            "_att.<filename>" for base64-encoded binary content (max 768 KiB decoded),
            "_attmeta.<filename>" for JSON metadata (content_type, size).
            Each attachment uses 2 fields toward the 64-field limit.

    GetItemResponse:
      type: object
      properties:
        item_id:
          type: string
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            Attachment content fields ("_att.*") are base64-encoded.

    UpdateItemRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            See PutItemRequest for attachment field conventions.

    AddMemberRequest:
      type: object
      required:
        - member_id
        - pub_key
        - role
      properties:
        member_id:
          type: string
        pub_key:
          type: string
          description: Base64 encoded 32-byte public key.
        role:
          type: string
          enum: [owner, writer, reader]

    AddMemberResponse:
      type: object
      properties:
        epoch:
          type: integer
          format: int64

    HistoryEntryResponse:
      type: object
      properties:
        version:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: string

    GetItemHistoryResponse:
      type: object
      properties:
        item_id:
          type: string
        history:
          type: array
          items:
            $ref: '#/components/schemas/HistoryEntryResponse'

    GetHistoryVersionResponse:
      type: object
      properties:
        item_id:
          type: string
        version:
          type: integer
          format: int64
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value at this version. Text fields are plain strings.
            Attachment content fields ("_att.*") are base64-encoded.

    AuditEntryResponse:
      type: object
      properties:
        id:
          type: string
        item_id:
          type: string
        action:
          type: string
          enum: [item_accessed, item_created, item_updated, item_deleted, vault_exported, vault_imported]
        member_id:
          type: string
        created_at:
          type: string
          format: date-time

    ListAuditLogsResponse:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntryResponse'

    ErrorResponse:
      type: object
      properties:
        error:
          type: string

    ExportVaultRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          description: Passphrase to encrypt the backup file. Must not be empty.

    ImportVaultResponse:
      type: object
      properties:
        imported_count:
          type: integer
          description: Number of items successfully imported.

paths:
  /auth/register:
    post:
      summary: Register a new account
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Invalid request (e.g. passphrase too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login with passphrase and secret key
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
        '401':
          description: Invalid credentials
        '429':
          description: Too many failed login attempts
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      summary: Logout current session
      operationId: logout
      responses:
        '200':
          description: Logged out

  /auth/2fa:
    get:
      summary: Get 2FA status for current account
      operationId: twoFactorStatus
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 2FA status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '401':
          description: Unauthorized

  /auth/2fa/setup:
    post:
      summary: Start 2FA setup and return a TOTP secret
      operationId: setupTwoFactor
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 2FA setup initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetupTwoFactorResponse'
        '401':
          description: Unauthorized

  /auth/2fa/enable:
    post:
      summary: Enable 2FA by verifying a TOTP code
      operationId: enableTwoFactor
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnableTwoFactorRequest'
      responses:
        '200':
          description: 2FA enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '400':
          description: Setup expired or invalid request
        '401':
          description: Invalid one-time code or unauthorized

  /vaults:
    get:
      summary: List vaults visible to authenticated member
      operationId: listVaults
      security:
        - SessionAuth: []
      responses:
        '200':
          description: Vault list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListVaultsResponse'
        '401':
          description: Unauthorized
    post:
      summary: Create a new vault
      operationId: createVault
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVaultRequest'
      responses:
        '201':
          description: Vault created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateVaultResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/open:
    post:
      summary: Open a vault
      operationId: openVault
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vault opened successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenVaultResponse'
        '401':
          description: Unauthorized
        '404':
          description: Vault not found

  /vaults/{vaultID}/items:
    get:
      summary: List items in a vault
      operationId: listItems
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of item IDs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}:
    get:
      summary: Get an item from a vault
      operationId: getItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetItemResponse'
        '401':
          description: Unauthorized
        '404':
          description: Item not found
    post:
      summary: Put an item into a vault
      operationId: putItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PutItemRequest'
      responses:
        '201':
          description: Item stored successfully
        '401':
          description: Unauthorized
    put:
      summary: Update an item in a vault
      operationId: updateItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
      responses:
        '200':
          description: Item updated successfully
        '401':
          description: Unauthorized
        '404':
          description: Item not found
    delete:
      summary: Delete an item from a vault
      operationId: deleteItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item deleted successfully
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}/history:
    get:
      summary: List version history for an item
      operationId: getItemHistory
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetItemHistoryResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}/history/{version}:
    get:
      summary: Get fields for a specific historical version of an item
      operationId: getHistoryVersion
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
        - name: version
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Historical version fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetHistoryVersionResponse'
        '401':
          description: Unauthorized
        '404':
          description: Version not found

  /vaults/{vaultID}/audit:
    get:
      summary: List vault audit log entries
      operationId: listAuditLogs
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: item_id
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Audit log entries (newest first)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAuditLogsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/members:
    post:
      summary: Add a member to a vault
      operationId: addMember
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberRequest'
      responses:
        '201':
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/members/{memberID}:
    delete:
      summary: Revoke a member from a vault
      operationId: revokeMember
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: memberID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}:
    delete:
      summary: Delete a vault
      operationId: deleteVault
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vault deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /vaults/{vaultID}/export:
    post:
      summary: Export all vault items as an encrypted backup
      operationId: exportVault
      description: >
        Requires owner access. Decrypts all current items, serializes to JSON,
        and encrypts with the provided passphrase using Argon2id + AES-256-GCM.
        History is not exported. The response is a binary blob.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportVaultRequest'
      responses:
        '200':
          description: Encrypted backup file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid request (e.g. empty passphrase)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner)

  /vaults/{vaultID}/import:
    post:
      summary: Import items from an encrypted backup into a vault
      operationId: importVault
      description: >
        Accepts a multipart form with the encrypted backup file and passphrase.
        Each imported item receives a new ID. Duplicates are not detected.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - passphrase
              properties:
                file:
                  type: string
                  format: binary
                  description: The .ironhand-backup file.
                passphrase:
                  type: string
                  description: Passphrase used to encrypt the backup.
      responses:
        '200':
          description: Items imported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportVaultResponse'
        '400':
          description: Invalid request, wrong passphrase, or corrupt file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
