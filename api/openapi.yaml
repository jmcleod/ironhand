openapi: 3.0.3
info:
  title: Ironhand API
  description: A secure vault service with end-to-end encryption.
  version: 1.0.0
servers:
  - url: /api/v1
    description: V1 API

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: ironhand_session
      description: HTTP-only session cookie returned by /auth/register or /auth/login.

  parameters:
    CSRFToken:
      name: X-CSRF-Token
      in: header
      required: true
      description: >
        CSRF double-submit token. Must match the value of the `ironhand_csrf`
        cookie. Required on all mutating (POST/PUT/DELETE) requests that use
        cookie-based session authentication. GET/HEAD/OPTIONS requests and
        header-authenticated requests are exempt.
      schema:
        type: string

  schemas:
    CreateVaultRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    CreateVaultResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string
        epoch:
          type: integer
          format: int64

    RegisterRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          minLength: 10
          description: Master passphrase (minimum 10 characters).

    RegisterResponse:
      type: object
      properties:
        secret_key:
          type: string

    LoginRequest:
      type: object
      required:
        - passphrase
        - secret_key
      properties:
        passphrase:
          type: string
        secret_key:
          type: string
        totp_code:
          type: string
          description: 6-digit TOTP code, required when 2FA is enabled.

    SetupTwoFactorResponse:
      type: object
      properties:
        secret:
          type: string
        otpauth_url:
          type: string
        expires_at:
          type: string
          format: date-time

    EnableTwoFactorRequest:
      type: object
      required:
        - code
      properties:
        code:
          type: string

    TwoFactorStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean

    WebAuthnStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean
        credential_count:
          type: integer

    WebAuthnLoginRequest:
      type: object
      required:
        - secret_key
        - passphrase
      properties:
        secret_key:
          type: string
        passphrase:
          type: string
          description: Passphrase for vault decryption after WebAuthn verification.

    WebAuthnRegistrationResponse:
      type: object
      properties:
        credential_id:
          type: string

    ExportAuditEntryResponse:
      type: object
      properties:
        id:
          type: string
        vault_id:
          type: string
        item_id:
          type: string
        action:
          type: string
        member_id:
          type: string
        created_at:
          type: string
          format: date-time
        prev_hash:
          type: string
          description: SHA-256 hash linking this entry to its predecessor in the tamper-evident chain.

    ExportAuditLogResponse:
      type: object
      properties:
        vault_id:
          type: string
        entries:
          type: array
          items:
            $ref: '#/components/schemas/ExportAuditEntryResponse'
        signature:
          type: string
          description: HMAC-SHA256 signature over all entries for forensic integrity verification.

    OpenVaultResponse:
      type: object
      properties:
        vault_id:
          type: string
        member_id:
          type: string
        epoch:
          type: integer
          format: int64

    VaultSummary:
      type: object
      properties:
        vault_id:
          type: string
        name:
          type: string
        description:
          type: string
        epoch:
          type: integer
          format: int64
        item_count:
          type: integer

    ListVaultsResponse:
      type: object
      properties:
        vaults:
          type: array
          items:
            $ref: '#/components/schemas/VaultSummary'

    ListItemsResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemSummary'

    ItemSummary:
      type: object
      properties:
        item_id:
          type: string
        name:
          type: string
        type:
          type: string

    PutItemRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            Attachment fields use special prefixes:
            "_att.<filename>" for base64-encoded binary content (max 768 KiB decoded),
            "_attmeta.<filename>" for JSON metadata (content_type, size).
            Each attachment uses 2 fields toward the 64-field limit.

    GetItemResponse:
      type: object
      properties:
        item_id:
          type: string
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            Attachment content fields ("_att.*") are base64-encoded.
            Sensitive fields such as `private_key` are returned as "[REDACTED]".
            Use the dedicated /private-key endpoint to retrieve the full value.

    UpdateItemRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value. Text fields are plain strings.
            See PutItemRequest for attachment field conventions.

    AddMemberRequest:
      type: object
      required:
        - member_id
        - pub_key
        - role
      properties:
        member_id:
          type: string
        pub_key:
          type: string
          description: Base64 encoded 32-byte public key.
        role:
          type: string
          enum: [owner, writer, reader]

    AddMemberResponse:
      type: object
      properties:
        epoch:
          type: integer
          format: int64

    HistoryEntryResponse:
      type: object
      properties:
        version:
          type: integer
          format: int64
        updated_at:
          type: string
          format: date-time
        updated_by:
          type: string

    GetItemHistoryResponse:
      type: object
      properties:
        item_id:
          type: string
        history:
          type: array
          items:
            $ref: '#/components/schemas/HistoryEntryResponse'

    GetHistoryVersionResponse:
      type: object
      properties:
        item_id:
          type: string
        version:
          type: integer
          format: int64
        fields:
          type: object
          additionalProperties:
            type: string
          description: >
            Map of field name to value at this version. Text fields are plain strings.
            Attachment content fields ("_att.*") are base64-encoded.

    AuditEntryResponse:
      type: object
      properties:
        id:
          type: string
        item_id:
          type: string
        action:
          type: string
          enum: [item_accessed, item_created, item_updated, item_deleted, vault_exported, vault_imported, ca_initialized, cert_issued, cert_revoked, cert_renewed, crl_generated, csr_signed, private_key_accessed, webauthn_registered, webauthn_login_success]
        member_id:
          type: string
        created_at:
          type: string
          format: date-time

    ListAuditLogsResponse:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntryResponse'

    ErrorResponse:
      type: object
      properties:
        error:
          type: string

    ExportVaultRequest:
      type: object
      required:
        - passphrase
      properties:
        passphrase:
          type: string
          description: Passphrase to encrypt the backup file. Must not be empty.

    ImportVaultResponse:
      type: object
      properties:
        imported_count:
          type: integer
          description: Number of items successfully imported.

    InitCARequest:
      type: object
      required:
        - common_name
      properties:
        common_name:
          type: string
        organization:
          type: string
        org_unit:
          type: string
        country:
          type: string
        province:
          type: string
        locality:
          type: string
        validity_years:
          type: integer
          description: CA certificate validity in years (default 10).
        is_intermediate:
          type: boolean
          description: Whether this is an intermediate CA (default false = root CA).

    InitCAResponse:
      type: object
      properties:
        subject:
          type: string

    CAInfoResponse:
      type: object
      properties:
        is_ca:
          type: boolean
        is_intermediate:
          type: boolean
        subject:
          type: string
        not_before:
          type: string
          format: date-time
        not_after:
          type: string
          format: date-time
        next_serial:
          type: integer
          format: int64
        crl_number:
          type: integer
          format: int64
        cert_count:
          type: integer

    IssueCertRequest:
      type: object
      required:
        - common_name
      properties:
        common_name:
          type: string
        organization:
          type: string
        org_unit:
          type: string
        country:
          type: string
        validity_days:
          type: integer
          description: Certificate validity in days (default 365).
        key_usages:
          type: array
          items:
            type: string
          description: >
            Key usage flags. Values: digital_signature, key_encipherment,
            data_encipherment, content_commitment.
        ext_key_usages:
          type: array
          items:
            type: string
          description: >
            Extended key usage values. Values: server_auth, client_auth,
            code_signing, email_protection.
        dns_names:
          type: array
          items:
            type: string
        ip_addresses:
          type: array
          items:
            type: string
        email_addresses:
          type: array
          items:
            type: string

    IssueCertResponse:
      type: object
      properties:
        item_id:
          type: string
        serial_number:
          type: string
        subject:
          type: string
        not_before:
          type: string
          format: date-time
        not_after:
          type: string
          format: date-time

    RevokeCertRequest:
      type: object
      properties:
        reason:
          type: string
          description: >
            Revocation reason. Values: unspecified, key_compromise,
            ca_compromise, affiliation_changed, superseded, cessation_of_operation.

    RenewCertRequest:
      type: object
      properties:
        validity_days:
          type: integer
          description: New certificate validity in days (default 365).

    RenewCertResponse:
      type: object
      properties:
        new_item_id:
          type: string
        old_item_id:
          type: string
        serial_number:
          type: string

    SignCSRRequest:
      type: object
      required:
        - csr
      properties:
        csr:
          type: string
          description: PEM-encoded PKCS#10 certificate signing request.
        validity_days:
          type: integer
          description: Certificate validity in days (default 365).
        ext_key_usages:
          type: array
          items:
            type: string

    SignCSRResponse:
      type: object
      properties:
        item_id:
          type: string
        serial_number:
          type: string
        certificate:
          type: string
          description: PEM-encoded signed certificate.

paths:
  /auth/register:
    post:
      summary: Register a new account
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
        '400':
          description: Invalid request (e.g. passphrase too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      summary: Login with passphrase and secret key
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Logged in
        '401':
          description: Invalid credentials
        '429':
          description: Too many failed login attempts
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      summary: Logout current session
      operationId: logout
      responses:
        '200':
          description: Logged out

  /auth/2fa:
    get:
      summary: Get 2FA status for current account
      operationId: twoFactorStatus
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 2FA status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '401':
          description: Unauthorized

  /auth/2fa/setup:
    post:
      summary: Start 2FA setup and return a TOTP secret
      operationId: setupTwoFactor
      security:
        - SessionAuth: []
      responses:
        '200':
          description: 2FA setup initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetupTwoFactorResponse'
        '401':
          description: Unauthorized

  /auth/2fa/enable:
    post:
      summary: Enable 2FA by verifying a TOTP code
      operationId: enableTwoFactor
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnableTwoFactorRequest'
      responses:
        '200':
          description: 2FA enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '400':
          description: Setup expired or invalid request
        '401':
          description: Invalid one-time code or unauthorized

  /auth/webauthn/status:
    get:
      summary: Get WebAuthn/passkey status
      operationId: webauthnStatus
      security:
        - SessionAuth: []
      responses:
        '200':
          description: WebAuthn status and credential count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnStatusResponse'
        '401':
          description: Unauthorized

  /auth/webauthn/register/begin:
    post:
      summary: Begin WebAuthn credential registration
      operationId: beginWebAuthnRegistration
      description: >
        Starts a WebAuthn registration ceremony. Returns PublicKeyCredentialCreationOptions
        for the browser to pass to navigator.credentials.create().
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Credential creation options
        '401':
          description: Unauthorized
        '404':
          description: WebAuthn not configured on server

  /auth/webauthn/register/finish:
    post:
      summary: Complete WebAuthn credential registration
      operationId: finishWebAuthnRegistration
      description: >
        Completes the WebAuthn registration ceremony by verifying the browser's
        attestation response and storing the credential.
      security:
        - SessionAuth: []
      parameters:
        - $ref: '#/components/parameters/CSRFToken'
      responses:
        '200':
          description: Credential registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebAuthnRegistrationResponse'
        '400':
          description: Registration failed or ceremony expired
        '401':
          description: Unauthorized
        '404':
          description: WebAuthn not configured on server

  /auth/webauthn/login/begin:
    post:
      summary: Begin WebAuthn login ceremony
      operationId: beginWebAuthnLogin
      description: >
        Starts a WebAuthn login ceremony. Requires secret_key and passphrase in the
        body because the passphrase is needed for vault decryption after successful
        WebAuthn verification. Returns PublicKeyCredentialRequestOptions for the
        browser to pass to navigator.credentials.get().
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebAuthnLoginRequest'
      responses:
        '200':
          description: Credential request options
        '400':
          description: No WebAuthn credentials registered
        '404':
          description: WebAuthn not configured on server
        '429':
          description: Too many failed login attempts
          headers:
            Retry-After:
              description: Seconds to wait before retrying
              schema:
                type: integer

  /auth/webauthn/login/finish:
    post:
      summary: Complete WebAuthn login ceremony
      operationId: finishWebAuthnLogin
      description: >
        Completes the WebAuthn login ceremony by verifying the browser's assertion
        response. On success, creates a full session (sets session and CSRF cookies).
      responses:
        '200':
          description: Login successful (session cookie set)
        '400':
          description: Ceremony expired or invalid response
        '401':
          description: WebAuthn verification failed or invalid passphrase
        '404':
          description: WebAuthn not configured on server

  /vaults:
    get:
      summary: List vaults visible to authenticated member
      operationId: listVaults
      security:
        - SessionAuth: []
      responses:
        '200':
          description: Vault list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListVaultsResponse'
        '401':
          description: Unauthorized
    post:
      summary: Create a new vault
      operationId: createVault
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVaultRequest'
      responses:
        '201':
          description: Vault created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateVaultResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/open:
    post:
      summary: Open a vault
      operationId: openVault
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vault opened successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OpenVaultResponse'
        '401':
          description: Unauthorized
        '404':
          description: Vault not found

  /vaults/{vaultID}/items:
    get:
      summary: List items in a vault
      operationId: listItems
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of item IDs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListItemsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}:
    get:
      summary: Get an item from a vault
      operationId: getItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetItemResponse'
        '401':
          description: Unauthorized
        '404':
          description: Item not found
    post:
      summary: Put an item into a vault
      operationId: putItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PutItemRequest'
      responses:
        '201':
          description: Item stored successfully
        '401':
          description: Unauthorized
    put:
      summary: Update an item in a vault
      operationId: updateItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateItemRequest'
      responses:
        '200':
          description: Item updated successfully
        '401':
          description: Unauthorized
        '404':
          description: Item not found
    delete:
      summary: Delete an item from a vault
      operationId: deleteItem
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Item deleted successfully
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}/history:
    get:
      summary: List version history for an item
      operationId: getItemHistory
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetItemHistoryResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/items/{itemID}/history/{version}:
    get:
      summary: Get fields for a specific historical version of an item
      operationId: getHistoryVersion
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
        - name: version
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Historical version fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetHistoryVersionResponse'
        '401':
          description: Unauthorized
        '404':
          description: Version not found

  /vaults/{vaultID}/items/{itemID}/private-key:
    get:
      summary: Get the private key for a certificate item
      operationId: getItemPrivateKey
      description: >
        Returns the full PEM-encoded private key for a certificate item.
        Requires owner access. The standard GetItem endpoint redacts the
        private_key field to "[REDACTED]" for security. This dedicated
        endpoint provides the real value and logs an audit event.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Private key PEM
          content:
            application/x-pem-file:
              schema:
                type: string
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner)
        '404':
          description: Item not found or has no private key

  /vaults/{vaultID}/audit:
    get:
      summary: List vault audit log entries
      operationId: listAuditLogs
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: item_id
          in: query
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Audit log entries (newest first)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAuditLogsResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/audit/export:
    get:
      summary: Export tamper-evident audit log
      operationId: exportAuditLog
      description: >
        Returns all audit entries for the vault with their chain hashes and
        an HMAC-SHA256 signature for forensic integrity verification. Entries
        are ordered chronologically (oldest first) and linked via prev_hash
        to form a tamper-evident chain.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Audit log with chain integrity data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportAuditLogResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/members:
    post:
      summary: Add a member to a vault
      operationId: addMember
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberRequest'
      responses:
        '201':
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/members/{memberID}:
    delete:
      summary: Revoke a member from a vault
      operationId: revokeMember
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: memberID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Member revoked successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}:
    delete:
      summary: Delete a vault
      operationId: deleteVault
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Vault deleted
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /vaults/{vaultID}/export:
    post:
      summary: Export all vault items as an encrypted backup
      operationId: exportVault
      description: >
        Requires owner access. Decrypts all current items, serializes to JSON,
        and encrypts with the provided passphrase using Argon2id + AES-256-GCM.
        History is not exported. The response is a binary blob.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportVaultRequest'
      responses:
        '200':
          description: Encrypted backup file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid request (e.g. empty passphrase)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner)

  /vaults/{vaultID}/pki/init:
    post:
      summary: Initialize vault as a Certificate Authority
      operationId: initCA
      description: >
        Creates a self-signed root CA (or intermediate CA) with the given subject.
        Generates an ECDSA P-256 CA key pair stored encrypted in the vault.
        Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InitCARequest'
      responses:
        '200':
          description: CA initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InitCAResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '409':
          description: Vault is already a CA
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/pki/info:
    get:
      summary: Get CA information
      operationId: getCAInfo
      description: Returns CA metadata including subject, validity, serial counter, and certificate count.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CA information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CAInfoResponse'
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/ca.pem:
    get:
      summary: Download CA certificate
      operationId: getCACert
      description: Returns the CA's X.509 certificate in PEM format.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CA certificate PEM
          content:
            text/plain:
              schema:
                type: string
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/issue:
    post:
      summary: Issue a new certificate
      operationId: issueCert
      description: >
        Issues a new X.509 certificate signed by the vault's CA.
        Generates a new ECDSA P-256 key pair. The certificate and private key
        are stored as a vault item. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueCertRequest'
      responses:
        '200':
          description: Certificate issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IssueCertResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/pki/items/{itemID}/revoke:
    post:
      summary: Revoke a certificate
      operationId: revokeCert
      description: >
        Marks a certificate as revoked. The revocation is recorded for CRL
        generation. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevokeCertRequest'
      responses:
        '200':
          description: Certificate revoked
        '401':
          description: Unauthorized
        '404':
          description: Certificate not found
        '409':
          description: Certificate already revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /vaults/{vaultID}/pki/items/{itemID}/renew:
    post:
      summary: Renew a certificate
      operationId: renewCert
      description: >
        Revokes the existing certificate and issues a new one with the same
        subject and SANs. The new item links back to the old one via
        previous_item_id. Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
        - name: itemID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RenewCertRequest'
      responses:
        '200':
          description: Certificate renewed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RenewCertResponse'
        '401':
          description: Unauthorized
        '404':
          description: Certificate not found

  /vaults/{vaultID}/pki/crl.pem:
    get:
      summary: Generate and download Certificate Revocation List
      operationId: getCRL
      description: >
        Generates a CRL on demand from the vault's revocation list, signed
        by the CA. Returns the CRL in PEM format.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: CRL in PEM format
          content:
            application/x-pem-file:
              schema:
                type: string
        '401':
          description: Unauthorized
        '404':
          description: Vault is not a CA

  /vaults/{vaultID}/pki/sign-csr:
    post:
      summary: Sign a Certificate Signing Request
      operationId: signCSR
      description: >
        Signs a PEM-encoded PKCS#10 CSR with the vault's CA. The resulting
        certificate is stored as a vault item (without private key, since the
        requester keeps their own key). Requires admin access.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignCSRRequest'
      responses:
        '200':
          description: CSR signed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignCSRResponse'
        '400':
          description: Invalid CSR
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /vaults/{vaultID}/import:
    post:
      summary: Import items from an encrypted backup into a vault
      operationId: importVault
      description: >
        Accepts a multipart form with the encrypted backup file and passphrase.
        Each imported item receives a new ID. Duplicates are not detected.
      security:
        - SessionAuth: []
      parameters:
        - name: vaultID
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - passphrase
              properties:
                file:
                  type: string
                  format: binary
                  description: The .ironhand-backup file.
                passphrase:
                  type: string
                  description: Passphrase used to encrypt the backup.
      responses:
        '200':
          description: Items imported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportVaultResponse'
        '400':
          description: Invalid request, wrong passphrase, or corrupt file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
